<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Life Compass Pro ‚Äî Vision Board</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* Small page-specific tweaks */
    .dropzone{
      border:2px dashed var(--line);
      border-radius:16px;
      padding:20px;
      text-align:center;
      color:var(--muted);
    }
    .dropzone.drag{ background: color-mix(in srgb, var(--panel) 90%, var(--accent) 10%); border-color: var(--accent) }
    .vision-grid{ display:grid; gap:12px; grid-template-columns:repeat(2,1fr) }
    @media(min-width:900px){ .vision-grid{ grid-template-columns:repeat(4,1fr) } }
    .vision-item{
      border:1px solid var(--line);
      border-radius:14px; background:var(--panel);
      box-shadow: var(--shadow-1); overflow:hidden;
      display:flex; flex-direction:column;
    }
    .vision-item img{ width:100%; aspect-ratio:1/1; object-fit:cover }
    .vision-item footer{ padding:10px; display:flex; gap:8px; align-items:center; justify-content:space-between }
    .vision-item footer input{ width:100%; padding:.5rem .6rem }
    .drag-handle{ cursor:grab; user-select:none; font-size:18px; opacity:.6 }
    .goal-row{ display:grid; gap:10px; grid-template-columns:1.2fr 1fr 120px 1fr 110px 110px }
    @media(max-width:900px){ .goal-row{ grid-template-columns:1fr } }
    .goal-row .badge{ justify-self:start }
    .goal-row .actions{ display:flex; gap:8px; flex-wrap:wrap }
    .filters{ display:flex; gap:8px; flex-wrap:wrap }
  </style>
</head>
<body>
    <script>
        // üîí Safe Login Guard with friendly message + debug
        (function () {
          try {
            const SESS_K = 'lc_session_v1';
            const MSG_K  = 'lc_redirect_msg';
        
            // Do NOT guard the auth page itself
            if (location.pathname.endsWith('auth.html')) return;
        
            // Allow manual bypass for testing: add ?noredirect
            if (location.search.includes('noredirect')) {
              console.warn('[Guard] Login check bypassed via ?noredirect');
              return;
            }
        
            // Read session (sessionStorage first, then localStorage)
            let raw = sessionStorage.getItem(SESS_K) || localStorage.getItem(SESS_K);
            if (!raw) {
              console.warn('[Guard] No session found -> redirecting to auth.html');
              localStorage.setItem(MSG_K, 'Your session expired or you need to log in first.');
              // If auth.html is missing, don't blank the page‚Äîjust stop here
              if (document.querySelector('a[href="auth.html"]') || true) {
                location.href = 'auth.html';
              } else {
                console.error('[Guard] auth.html not found; staying on page.');
              }
              return;
            }
        
            let sess = null;
            try { sess = JSON.parse(raw); } catch { sess = null; }
        
            if (!sess || !sess.token) {
              console.warn('[Guard] Bad session format -> redirecting');
              localStorage.setItem(MSG_K, 'Your session expired or you need to log in first.');
              location.href = 'auth.html';
              return;
            }
        
            // Optional timeout (24h)
            const ONE_DAY = 24 * 60 * 60 * 1000;
            if (!sess.ts || Date.now() - sess.ts > ONE_DAY) {
              console.warn('[Guard] Session old/expired -> redirecting');
              localStorage.removeItem(SESS_K);
              sessionStorage.removeItem(SESS_K);
              localStorage.setItem(MSG_K, 'Your session has expired after 24 hours. Please sign in again.');
              location.href = 'auth.html';
            }
          } catch (e) {
            console.error('[Guard] Error in guard:', e);
            // Fail open: do nothing so page still renders
          }
        })();
        </script>
  <!-- Header -->
  <header class="site-header">
    <div class="wrap">
      <a class="brand" href="index.html">Life Compass Pro</a>
      <nav>
        <a href="index.html#home">Home</a>
        <a href="#vision">Vision Board</a>
        <a href="therapy.html">Therapy Mode</a>
        <a href="school.html">School Mode</a>
        <a href="#" id="logoutBtn">Logout</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <!-- Vision Board -->
    <section class="card">
      <h1>üåø Vision Board</h1>
      <p class="muted">Add images that inspire you. Drag to reorder. Captions are saved automatically.</p>

      <div class="grid2">
        <div class="stack-md">
          <div class="dropzone" id="dz">
            <p><b>Drop images here</b> or click to upload</p>
            <input id="file" type="file" accept="image/*" multiple class="hidden" />
            <button class="btn btn-primary" id="pick">Choose Images</button>
            <p class="muted">Tip: You can also paste an image (‚åò/Ctrl + V)</p>
          </div>
          <div class="stack-sm">
            <button class="btn btn-ghost" id="exportVisionHTML">Export Vision (HTML)</button>
            <button class="btn btn-ghost" id="exportVisionJSON">Export Vision (JSON)</button>
            <button class="btn btn-danger" id="clearVision">Clear Vision (local)</button>
          </div>
        </div>

        <div>
          <div id="visionGrid" class="vision-grid"></div>
        </div>
      </div>
    </section>

    <!-- Goals -->
    <section class="card">
      <h2>üéØ Goals</h2>
      <p class="muted">Define clear goals tied to your vision. Track progress and celebrate wins.</p>

      <div class="form-grid cols-2">
        <label>Goal Title
          <input id="g_title" placeholder="e.g., Walk 20 minutes daily" />
        </label>
        <label>Category
          <select id="g_cat">
            <option>Spiritual</option>
            <option>Physical</option>
            <option>Emotional</option>
            <option>Mental</option>
            <option>Financial</option>
            <option>Other</option>
          </select>
        </label>
        <label>Due Date
          <input id="g_due" type="date" />
        </label>
        <label>Progress (%)
          <input id="g_prog" type="number" min="0" max="100" value="0" />
        </label>
      </div>
      <button class="btn btn-success mt-2" id="g_add">Add Goal</button>

      <div class="space"></div>
      <div class="filters">
        <span class="badge">Filter:</span>
        <button class="btn btn-ghost" data-filter="All">All</button>
        <button class="btn btn-ghost" data-filter="Spiritual">Spiritual</button>
        <button class="btn btn-ghost" data-filter="Physical">Physical</button>
        <button class="btn btn-ghost" data-filter="Emotional">Emotional</button>
        <button class="btn btn-ghost" data-filter="Mental">Mental</button>
        <button class="btn btn-ghost" data-filter="Financial">Financial</button>
        <button class="btn btn-ghost" data-filter="Other">Other</button>
        <button class="btn btn-ghost" id="showOpen">Open</button>
        <button class="btn btn-ghost" id="showDone">Completed</button>
      </div>

      <div id="goalList" class="stack-md mt-2"></div>

      <div class="stack-sm mt-2">
        <button class="btn btn-primary" id="exportGoalsHTML">Export Goals (HTML)</button>
        <button class="btn btn-ghost" id="exportGoalsCSV">Export Goals (CSV)</button>
        <button class="btn btn-ghost" id="exportGoalsJSON">Export Goals (JSON)</button>
        <button class="btn btn-danger" id="clearGoals">Clear Goals (local)</button>
      </div>
    </section>
  </main>

  <footer>
    <p>Guided by Faith. Strengthened by Fire. Moved by Stillness.</p>
    <p>&copy; 2025 Life Compass Pro ‚Äî by LovingSmiles</p>
  </footer>

  <script>
    /* ===== Helpers ===== */
    const $ = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
    const save = (k,v)=>localStorage.setItem(k, JSON.stringify(v));
    const read = (k, fb)=>{ try{return JSON.parse(localStorage.getItem(k)) ?? fb;}catch{ return fb; } };
    const uid = ()=>crypto?.randomUUID?.() || Math.random().toString(36).slice(2);

    function toast(msg, ms=2200){
      const t=document.createElement('div'); t.className='toast'; t.textContent=msg;
      document.body.appendChild(t); setTimeout(()=>t.remove(), ms);
    }
    function download(name, text, type='text/plain'){
      const a=document.createElement('a');
      a.href=URL.createObjectURL(new Blob([text],{type}));
      a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000);
    }
    function toCSV(rows){
      if(!rows.length) return '';
      const keys=Object.keys(rows[0]);
      const esc=s=>`"${String(s??'').replace(/"/g,'""')}"`;
      return keys.map(esc).join(',')+'\n'+rows.map(r=>keys.map(k=>esc(r[k])).join(',')).join('\n');
    }
    function htmlDoc(title, body){
      return `<!doctype html><meta charset="utf-8"><title>${title}</title><style>
        body{font:16px/1.6 system-ui,Segoe UI,Roboto,Arial,sans-serif;color:#111;background:#fff;margin:40px;max-width:900px}
        .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin:10px 0}
        h1,h2,h3{margin:.2rem 0} .muted{color:#666}
        table{border-collapse:collapse;width:100%} th,td{border:1px solid #ddd;padding:8px;text-align:left} th{background:#f6f7fb}
      </style><h1>${title}</h1>${body}`;
    }

    /* ===== Vision Board ===== */
    const VKEY = 'lc_vision_items';
    let vision = read(VKEY, []); // {id, url, caption, ts}

    function renderVision(){
      const grid = $('#visionGrid');
      grid.innerHTML = '';
      vision.forEach((v, idx)=>{
        const item = document.createElement('article');
        item.className='vision-item';
        item.draggable = true;
        item.dataset.id = v.id;
        item.innerHTML = `
          <img src="${v.url}" alt="Vision item" />
          <footer>
            <input type="text" placeholder="Caption‚Ä¶" value="${(v.caption||'').replace(/"/g,'&quot;')}" data-id="${v.id}" />
            <span class="drag-handle" title="Drag to reorder">‚ãÆ‚ãÆ</span>
            <button class="btn btn-ghost" data-del="${v.id}">Delete</button>
          </footer>`;
        // drag events
        item.addEventListener('dragstart', (e)=>{ e.dataTransfer.setData('text/plain', v.id); });
        item.addEventListener('dragover', (e)=>{ e.preventDefault(); });
        item.addEventListener('drop', (e)=>{
          e.preventDefault();
          const fromId = e.dataTransfer.getData('text/plain');
          const toId = v.id;
          reorderVision(fromId, toId);
        });
        grid.appendChild(item);
      });
    }
    function reorderVision(fromId, toId){
      if(fromId===toId) return;
      const fromIdx = vision.findIndex(x=>x.id===fromId);
      const toIdx   = vision.findIndex(x=>x.id===toId);
      if(fromIdx<0 || toIdx<0) return;
      const [moved] = vision.splice(fromIdx,1);
      vision.splice(toIdx,0,moved);
      save(VKEY, vision); renderVision();
    }

    async function dataURLFromFile(file){
      return await new Promise((res,rej)=>{
        const fr=new FileReader();
        fr.onload=()=>res(fr.result); fr.onerror=()=>rej(fr.error);
        fr.readAsDataURL(file);
      });
    }
    async function addImages(files){
      if(!files?.length) return;
      for (const f of files){
        if(!f.type.startsWith('image/')) continue;
        const url = await dataURLFromFile(f);
        vision.push({ id:uid(), url, caption:'', ts:Date.now() });
      }
      save(VKEY, vision); renderVision(); toast('Added to vision');
    }

    function setupVisionUI(){
      const dz = $('#dz'); const file = $('#file'); const pick = $('#pick');
      pick.addEventListener('click', ()=>file.click());
      file.addEventListener('change', ()=>{ addImages(file.files); file.value=''; });

      // drag & drop
      ;['dragenter','dragover'].forEach(evt=>dz.addEventListener(evt, e=>{ e.preventDefault(); dz.classList.add('drag'); }));
      ;['dragleave','drop'].forEach(evt=>dz.addEventListener(evt, e=>{ e.preventDefault(); dz.classList.remove('drag'); }));
      dz.addEventListener('drop', (e)=> addImages(e.dataTransfer.files));

      // paste image
      document.addEventListener('paste', async (e)=>{
        const items = e.clipboardData?.items || [];
        const imgs = [];
        for (const it of items){
          if(it.type?.startsWith('image/')) imgs.push(it.getAsFile());
        }
        if(imgs.length){ addImages(imgs); }
      });

      // caption + delete
      $('#visionGrid').addEventListener('input', (e)=>{
        const id = e.target.getAttribute('data-id'); if(!id) return;
        const it = vision.find(x=>x.id===id); if(!it) return;
        it.caption = e.target.value;
        save(VKEY, vision);
      });
      $('#visionGrid').addEventListener('click', (e)=>{
        const id = e.target.getAttribute('data-del'); if(!id) return;
        vision = vision.filter(x=>x.id!==id);
        save(VKEY, vision); renderVision(); toast('Removed');
      });

      // exports / clear
      $('#exportVisionJSON').addEventListener('click', ()=>{
        download('vision.json', JSON.stringify(vision,null,2), 'application/json');
      });
      $('#exportVisionHTML').addEventListener('click', ()=>{
        const body = `
          <div class="card"><h2>Vision Board</h2>
            <div style="display:grid;gap:8px;grid-template-columns:repeat(3,1fr)">
              ${vision.map(v=>`<figure style="border:1px solid #ddd;border-radius:8px;padding:6px">
                <img src="${v.url}" style="width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:6px"/>
                ${v.caption?`<figcaption style="color:#444;margin-top:6px">${v.caption.replace(/</g,'&lt;')}</figcaption>`:''}
              </figure>`).join('')}
            </div>
          </div>`;
        download('vision_board.html', htmlDoc('Vision Board ‚Äî Life Compass Pro', body), 'text/html');
      });
      $('#clearVision').addEventListener('click', ()=>{
        if(confirm('Clear vision (local only)?')){ vision=[]; save(VKEY, vision); renderVision(); }
      });

      renderVision();
    }

    /* ===== Goals ===== */
    const GKEY = 'lc_goals';
    let goals = read(GKEY, []); // {id,title,cat,due,prog,done,ts}

    function renderGoals(filter='All', state='All'){
      const host = $('#goalList'); host.innerHTML='';
      let list = goals.slice().sort((a,b)=> (a.done - b.done) || (a.due||'').localeCompare(b.due||'') );
      if(filter!=='All') list = list.filter(g=>g.cat===filter);
      if(state==='Open') list = list.filter(g=>!g.done);
      if(state==='Done') list = list.filter(g=>g.done);

      if(!list.length){
        host.innerHTML = `<div class="muted">No goals yet. Add one above.</div>`;
        return;
      }

      list.forEach(g=>{
        const row = document.createElement('div');
        row.className='goal-row card';
        row.dataset.id = g.id;
        row.innerHTML = `
          <div>
            <strong>${g.title||'(Untitled goal)'}</strong>
            ${g.done?'<span class="badge">Done</span>':''}
            <div class="muted">Created: ${new Date(g.ts).toLocaleDateString()}</div>
          </div>
          <div><span class="badge">${g.cat||'Other'}</span></div>
          <div><span class="muted">Due</span><br>${g.due||'‚Äî'}</div>
          <div><span class="muted">Progress</span><br>${g.prog||0}%</div>
          <div class="actions">
            <button class="btn btn-ghost" data-act="edit">Edit</button>
            <button class="btn btn-ghost" data-act="toggle">${g.done?'Undo':'Complete'}</button>
          </div>
          <div class="actions">
            <button class="btn btn-ghost" data-act="inc">+10%</button>
            <button class="btn btn-ghost" data-act="dec">-10%</button>
            <button class="btn btn-danger" data-act="del">Delete</button>
          </div>
        `;
        host.appendChild(row);
      });
    }

    function setupGoalsUI(){
      $('#g_add').addEventListener('click', ()=>{
        const title = $('#g_title').value.trim();
        const cat   = $('#g_cat').value;
        const due   = $('#g_due').value;
        const prog  = Math.max(0, Math.min(100, parseInt($('#g_prog').value||'0',10)));
        if(!title){ toast('Please enter a goal title'); return; }
        const g = { id:uid(), title, cat, due, prog, done:false, ts:Date.now() };
        goals.push(g); save(GKEY, goals);
        $('#g_title').value=''; $('#g_due').value=''; $('#g_prog').value='0';
        renderGoals(currentFilter, currentState); toast('Goal added');
      });

      // Filters
      let currentFilter='All', currentState='All';
      $$('.filters [data-filter]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          currentFilter = btn.getAttribute('data-filter');
          renderGoals(currentFilter, currentState);
        });
      });
      $('#showOpen').addEventListener('click', ()=>{ currentState='Open'; renderGoals(currentFilter,currentState); });
      $('#showDone').addEventListener('click', ()=>{ currentState='Done'; renderGoals(currentFilter,currentState); });

      // Row actions
      $('#goalList').addEventListener('click', (e)=>{
        const act = e.target.getAttribute('data-act'); if(!act) return;
        const id  = e.target.closest('.goal-row')?.dataset.id;
        const g   = goals.find(x=>x.id===id); if(!g) return;

        if(act==='toggle'){ g.done=!g.done; if(g.done) g.prog=100; save(GKEY, goals); renderGoals(currentFilter,currentState); return; }
        if(act==='inc'){ g.prog=Math.min(100, (g.prog||0)+10); save(GKEY, goals); renderGoals(currentFilter,currentState); return; }
        if(act==='dec'){ g.prog=Math.max(0, (g.prog||0)-10); save(GKEY, goals); renderGoals(currentFilter,currentState); return; }
        if(act==='del'){ goals=goals.filter(x=>x.id!==id); save(GKEY, goals); renderGoals(currentFilter,currentState); return; }
        if(act==='edit'){
          const title = prompt('Edit title', g.title||'') ?? g.title;
          const due   = prompt('Edit due date (YYYY-MM-DD)', g.due||'') ?? g.due;
          const prog  = parseInt(prompt('Edit progress (0‚Äì100)', g.prog||0) ?? g.prog,10);
          if(title!=null) g.title = title.trim();
          if(due!=null)   g.due = due.trim();
          if(!Number.isNaN(prog)) g.prog = Math.max(0, Math.min(100, prog));
          save(GKEY, goals); renderGoals(currentFilter,currentState);
        }
      });

      // Exports & clear
      $('#exportGoalsJSON').addEventListener('click', ()=>{
        download('goals.json', JSON.stringify(goals,null,2), 'application/json');
      });
      $('#exportGoalsCSV').addEventListener('click', ()=>{
        const csv = toCSV(goals.map(g=>({title:g.title,category:g.cat,due:g.due,progress:g.prog,completed:g.done,created:new Date(g.ts).toISOString()})));
        download('goals.csv', csv, 'text/csv');
      });
      $('#exportGoalsHTML').addEventListener('click', ()=>{
        const body = `
          <div class="card"><h2>Goals</h2>${
            goals.length? `<table><tr><th>Title</th><th>Category</th><th>Due</th><th>Progress</th><th>Status</th></tr>`+
            goals.map(g=>`<tr><td>${(g.title||'').replace(/</g,'&lt;')}</td><td>${g.cat}</td><td>${g.due||'‚Äî'}</td><td>${g.prog||0}%</td><td>${g.done?'Done':'Open'}</td></tr>`).join('')+
            `</table>` : `<p class="muted">No goals yet.</p>`
          }</div>`;
        download('goals.html', htmlDoc('Goals ‚Äî Life Compass Pro', body), 'text/html');
      });
      $('#clearGoals').addEventListener('click', ()=>{
        if(confirm('Clear all goals (local only)?')){ goals=[]; save(GKEY, goals); renderGoals(); }
      });

      // Initial render
      renderGoals();
    }

    // Init
    document.addEventListener('DOMContentLoaded', ()=>{
      setupVisionUI();
      setupGoalsUI();
      // --- AI Settings Integration ---
(function(){
  const LS_API = 'aihelper_api_key';
  let OPENAI_API_KEY = localStorage.getItem(LS_API) || "";

  // Create floating settings button (‚öôÔ∏è)
  const btn = document.createElement('button');
  btn.textContent = '‚öôÔ∏è';
  Object.assign(btn.style, {
    position:'fixed', bottom:'20px', right:'20px',
    width:'48px', height:'48px',
    background:'#444', color:'#fff', border:'none',
    borderRadius:'50%', cursor:'pointer', fontSize:'20px',
    boxShadow:'0 2px 6px rgba(0,0,0,0.3)', zIndex:9999
  });
  document.body.appendChild(btn);

  // Create settings panel
  const panel = document.createElement('div');
  panel.id = 'settingsPanel';
  panel.innerHTML = `
    <h4>üîë AI Settings</h4>
    <p style="font-size:.9rem;color:#555;">Your API key is stored locally ‚Äî never uploaded.</p>
    <input id="apiKeyInput" type="password" placeholder="Enter your OpenAI API key"
      style="width:100%;padding:8px;margin-bottom:10px;border-radius:6px;border:1px solid #ccc;">
    <button id="saveKeyBtn" style="width:100%;background:#0078ff;color:#fff;border:none;padding:8px;border-radius:6px;cursor:pointer;">
      Save Key
    </button>`;
  Object.assign(panel.style,{
    position:'fixed',top:'80px',right:'20px',background:'#fff',
    border:'1px solid #ccc',borderRadius:'10px',boxShadow:'0 2px 8px rgba(0,0,0,0.2)',
    padding:'20px',width:'280px',display:'none',zIndex:9998
  });
  document.body.appendChild(panel);

  // Toggle panel visibility
  btn.addEventListener('click',()=>{
    panel.style.display=(panel.style.display==='none'||!panel.style.display)?'block':'none';
    document.getElementById('apiKeyInput').value = OPENAI_API_KEY;
  });

  // Save API key
  panel.querySelector('#saveKeyBtn').addEventListener('click',()=>{
    const key = document.getElementById('apiKeyInput').value.trim();
    localStorage.setItem(LS_API, key);
    OPENAI_API_KEY = key;
    alert('‚úÖ API key saved locally.');
    panel.style.display='none';
  });
})();
    });
    // Logout: clears local/session storage and redirects to login
document.getElementById('logoutBtn')?.addEventListener('click', () => {
  localStorage.removeItem('lc_session_v1');
  sessionStorage.removeItem('lc_session_v1');
  alert('‚úÖ You have been logged out.');
  window.location.href = 'auth.html'; // make sure this points to the right path
});
  </script>
</body>
</html>